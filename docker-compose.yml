---
version: "3.9"

x-logging:
  &default-logging
  options:
    max-size: "100k"
    max-file: "5"
  driver: json-file

services:
  #=============================================================================
  # media servers
  #=============================================================================

  plex:
    image: linuxserver/plex
    container_name: plex
    logging: *default-logging
    runtime: nvidia
    environment:
      # plex
      - DATABASE_FILES=com.plexapp.dlna com.plexapp.plugins.library.blobs com.plexapp.plugins.library
      - DATABASE_PATH=/config/Library/Application Support/Plex Media Server/Plug-in Support/Databases
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-Europe/London}
      - VERSION=latest
      # nvidia
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,video,utility
      # dockergen
      - "VIRTUAL_HOST=\
          ${HTTP_HOST:-127.0.0.1.sslip.io},\
          ~^[0-9a-f:.]+\\.sslip\\.io$$"
      - CERT_NAME=${HTTP_HOST:-127.0.0.1.sslip.io}
      - VIRTUAL_PORT=32400
      # nginx-proxy-letsencrypt
      - ${LE_HOST_KEY:-NGINX_SSL_HOST}=${HTTP_HOST:-}
      - LETSENCRYPT_EMAIL=${LETSENCRYPT_EMAIL:-}
    ports:
      - ${PLEX_PORT:-32400}:32400
    volumes:
      - ./config/plex:/config
      - plex_database:/databases
      - ./cache/plex:/transcode
      - ./media:/media
      - ./share/databases/cont-init:/etc/cont-init.d/20-database
      - ./share/databases/cont-finish:/etc/cont-finish.d/20-database
      # Optional volumes, e.g. to follow symlinks
      - ${EXTRA_DATA_VOL_0:-/dev/null}:${EXTRA_DATA_VOL_0:-/dev/null0}
      - ${EXTRA_DATA_VOL_1:-/dev/null}:${EXTRA_DATA_VOL_1:-/dev/null1}
      - ${EXTRA_DATA_VOL_2:-/dev/null}:${EXTRA_DATA_VOL_2:-/dev/null2}
      - ${EXTRA_DATA_VOL_3:-/dev/null}:${EXTRA_DATA_VOL_3:-/dev/null3}
      - ${EXTRA_DATA_VOL_4:-/dev/null}:${EXTRA_DATA_VOL_4:-/dev/null4}
      - ${EXTRA_DATA_VOL_5:-/dev/null}:${EXTRA_DATA_VOL_5:-/dev/null5}
      # # NTFS-3G directory junction mappings
      # - ./share/.NTFS-3G:/mnt/${NTFS_DRIVE:-c}/.NTFS-3G:ro
    restart: unless-stopped

  tautulli:
    image: linuxserver/tautulli
    container_name: tautulli
    environment:
      # tautulli
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-Europe/London}
      # dockergen
      - "VIRTUAL_HOST=\
          tautulli.${HTTP_HOST:-127.0.0.1.sslip.io},\
          ~^tautulli\\.[0-9a-f:.]+\\.sslip\\.io$$"
      - CERT_NAME=tautulli.${HTTP_HOST:-127.0.0.1.sslip.io}
      - VIRTUAL_PORT=8181
      # nginx-proxy-letsencrypt
      - ${LE_HOST_KEY:-NGINX_SSL_HOST}=tautulli.${HTTP_HOST:-}
      - LETSENCRYPT_EMAIL=${LETSENCRYPT_EMAIL:-}
    volumes:
      - ./config/tautulli:/config
      - ./config/plex/Library/Application Support/Plex Media Server/Logs:/logs
    restart: unless-stopped

  #=============================================================================
  # media management
  #=============================================================================

  sonarr:
    image: linuxserver/sonarr
    container_name: sonarr
    logging: *default-logging
    environment:
      # sonarr
      - DATABASE_FILES=nzbdrone logs
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-Europe/London}
      - XDG_CONFIG_HOME=/tmp/xdg
      # dockergen
      - "VIRTUAL_HOST=\
          sonarr.${HTTP_HOST:-127.0.0.1.sslip.io},\
          ~^sonarr\\.[0-9a-f:.]+\\.sslip\\.io$$"
      - CERT_NAME=sonarr.${HTTP_HOST:-127.0.0.1.sslip.io}
      - VIRTUAL_PORT=8989
      # nginx-proxy-letsencrypt
      - ${LE_HOST_KEY:-NGINX_SSL_HOST}=sonarr.${HTTP_HOST:-}
      - LETSENCRYPT_EMAIL=${LETSENCRYPT_EMAIL:-}
    volumes:
      - sonarr_database:/databases
      - ./config/sonarr:/config
      - ./media:/media
      - ./share/databases/cont-init:/etc/cont-init.d/20-database
      - ./share/databases/cont-finish:/etc/cont-finish.d/20-database
      # Optional volumes, e.g. to follow symlinks
      - ${EXTRA_DATA_VOL_0:-/dev/null}:${EXTRA_DATA_VOL_0:-/dev/null0}
      - ${EXTRA_DATA_VOL_1:-/dev/null}:${EXTRA_DATA_VOL_1:-/dev/null1}
      - ${EXTRA_DATA_VOL_2:-/dev/null}:${EXTRA_DATA_VOL_2:-/dev/null2}
      - ${EXTRA_DATA_VOL_3:-/dev/null}:${EXTRA_DATA_VOL_3:-/dev/null3}
      - ${EXTRA_DATA_VOL_4:-/dev/null}:${EXTRA_DATA_VOL_4:-/dev/null4}
      - ${EXTRA_DATA_VOL_5:-/dev/null}:${EXTRA_DATA_VOL_5:-/dev/null5}
      # # NTFS-3G directory junction mappings
      # - ./share/.NTFS-3G:/mnt/${NTFS_DRIVE:-c}/.NTFS-3G:ro
    depends_on:
      - prowlarr
    restart: unless-stopped

  radarr:
    image: linuxserver/radarr
    container_name: radarr
    logging: *default-logging
    environment:
      # radarr
      - DATABASE_FILES=nzbdrone logs
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-Europe/London}
      - XDG_CONFIG_HOME=/tmp/xdg
      # dockergen
      - "VIRTUAL_HOST=\
          radarr.${HTTP_HOST:-127.0.0.1.sslip.io},\
          ~^radarr\\.[0-9a-f:.]+\\.sslip\\.io$$"
      - CERT_NAME=radarr.${HTTP_HOST:-127.0.0.1.sslip.io}
      - VIRTUAL_PORT=7878
      # nginx-proxy-letsencrypt
      - ${LE_HOST_KEY:-NGINX_SSL_HOST}=radarr.${HTTP_HOST:-}
      - LETSENCRYPT_EMAIL=${LETSENCRYPT_EMAIL:-}
    volumes:
      - radarr_database:/databases
      - ./config/radarr:/config
      - ./media:/media
      - ./share/databases/cont-init:/etc/cont-init.d/20-database
      - ./share/databases/cont-finish:/etc/cont-finish.d/20-database
      # Optional volumes, e.g. to follow symlinks
      - ${EXTRA_DATA_VOL_0:-/dev/null}:${EXTRA_DATA_VOL_0:-/dev/null0}
      - ${EXTRA_DATA_VOL_1:-/dev/null}:${EXTRA_DATA_VOL_1:-/dev/null1}
      - ${EXTRA_DATA_VOL_2:-/dev/null}:${EXTRA_DATA_VOL_2:-/dev/null2}
      - ${EXTRA_DATA_VOL_3:-/dev/null}:${EXTRA_DATA_VOL_3:-/dev/null3}
      - ${EXTRA_DATA_VOL_4:-/dev/null}:${EXTRA_DATA_VOL_4:-/dev/null4}
      - ${EXTRA_DATA_VOL_5:-/dev/null}:${EXTRA_DATA_VOL_5:-/dev/null5}
      # # NTFS-3G directory junction mappings
      # - ./share/.NTFS-3G:/mnt/${NTFS_DRIVE:-c}/.NTFS-3G:ro
    depends_on:
      - prowlarr
    restart: unless-stopped

  lidarr:
    image: linuxserver/lidarr
    container_name: lidarr
    logging: *default-logging
    environment:
      # lidarr
      - DATABASE_FILES=lidarr logs
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-Europe/London}
      - XDG_CONFIG_HOME=/tmp/xdg
      # dockergen
      - "VIRTUAL_HOST=\
          lidarr.${HTTP_HOST:-127.0.0.1.sslip.io},\
          ~^lidarr\\.[0-9a-f:.]+\\.sslip\\.io$$"
      - CERT_NAME=lidarr.${HTTP_HOST:-127.0.0.1.sslip.io}
      - VIRTUAL_PORT=8686
      # nginx-proxy-letsencrypt
      - ${LE_HOST_KEY:-NGINX_SSL_HOST}=lidarr.${HTTP_HOST:-}
      - LETSENCRYPT_EMAIL=${LETSENCRYPT_EMAIL:-}
    volumes:
      - lidarr_database:/databases
      - ./config/lidarr:/config
      - ./media:/media
      - ./share/databases/cont-init:/etc/cont-init.d/20-database
      - ./share/databases/cont-finish:/etc/cont-finish.d/20-database
      # Optional volumes, e.g. to follow symlinks
      - ${EXTRA_DATA_VOL_0:-/dev/null}:${EXTRA_DATA_VOL_0:-/dev/null0}
      - ${EXTRA_DATA_VOL_1:-/dev/null}:${EXTRA_DATA_VOL_1:-/dev/null1}
      - ${EXTRA_DATA_VOL_2:-/dev/null}:${EXTRA_DATA_VOL_2:-/dev/null2}
      - ${EXTRA_DATA_VOL_3:-/dev/null}:${EXTRA_DATA_VOL_3:-/dev/null3}
      - ${EXTRA_DATA_VOL_4:-/dev/null}:${EXTRA_DATA_VOL_4:-/dev/null4}
      - ${EXTRA_DATA_VOL_5:-/dev/null}:${EXTRA_DATA_VOL_5:-/dev/null5}
      # # NTFS-3G directory junction mappings
      # - ./share/.NTFS-3G:/mnt/${NTFS_DRIVE:-c}/.NTFS-3G:ro
    depends_on:
      - prowlarr
    restart: unless-stopped

  readarr:
    image: ghcr.io/linuxserver/readarr:nightly
    container_name: readarr
    logging: *default-logging
    environment:
      # readarr
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-Europe/London}
      # dockergen
      - "VIRTUAL_HOST=\
          readarr.${HTTP_HOST:-127.0.0.1.sslip.io},\
          ~^readarr\\.[0-9a-f:.]+\\.sslip\\.io$$"
      - CERT_NAME=readarr.${HTTP_HOST:-127.0.0.1.sslip.io}
      - VIRTUAL_PORT=8787
      # nginx-proxy-letsencrypt
      - ${LE_HOST_KEY:-NGINX_SSL_HOST}=readarr.${HTTP_HOST:-}
      - LETSENCRYPT_EMAIL=${LETSENCRYPT_EMAIL:-}
    volumes:
      - ./config/readarr:/config
      - ./media:/media
      # Optional volumes, e.g. to follow symlinks
      - ${EXTRA_DATA_VOL_0:-/dev/null}:${EXTRA_DATA_VOL_0:-/dev/null0}
      - ${EXTRA_DATA_VOL_1:-/dev/null}:${EXTRA_DATA_VOL_1:-/dev/null1}
      - ${EXTRA_DATA_VOL_2:-/dev/null}:${EXTRA_DATA_VOL_2:-/dev/null2}
      - ${EXTRA_DATA_VOL_3:-/dev/null}:${EXTRA_DATA_VOL_3:-/dev/null3}
      - ${EXTRA_DATA_VOL_4:-/dev/null}:${EXTRA_DATA_VOL_4:-/dev/null4}
      - ${EXTRA_DATA_VOL_5:-/dev/null}:${EXTRA_DATA_VOL_5:-/dev/null5}
      # # NTFS-3G directory junction mappings
      # - ./share/.NTFS-3G:/mnt/${NTFS_DRIVE:-c}/.NTFS-3G:ro
    restart: unless-stopped

  overseerr:
    image: linuxserver/overseerr
    container_name: overseerr
    environment:
      # overseerr
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-Europe/London}
      # dockergen
      - "VIRTUAL_HOST=\
          requests.${HTTP_HOST:-127.0.0.1.sslip.io},\
          ~^requests\\.[0-9a-f:.]+\\.sslip\\.io$$"
      - CERT_NAME=requests.${HTTP_HOST:-127.0.0.1.sslip.io}
      - VIRTUAL_PORT=5055
      # nginx-proxy-letsencrypt
      - ${LE_HOST_KEY:-NGINX_SSL_HOST}=requests.${HTTP_HOST:-}
      - LETSENCRYPT_EMAIL=${LETSENCRYPT_EMAIL:-}
    volumes:
      - ./config/overseerr:/config
    restart: unless-stopped

  #=============================================================================
  # indexer middleware
  #=============================================================================

  prowlarr:
    image: ghcr.io/linuxserver/prowlarr:develop
    container_name: prowlarr
    logging: *default-logging
    environment:
      # prowlarr
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-Europe/London}
      # dockergen
      - "VIRTUAL_HOST=\
          prowlarr.${HTTP_HOST:-127.0.0.1.sslip.io},\
          ~^prowlarr\\.[0-9a-f:.]+\\.sslip\\.io$$"
      - CERT_NAME=prowlarr.${HTTP_HOST:-127.0.0.1.sslip.io}
      - VIRTUAL_PORT=9696
      # nginx-proxy-letsencrypt
      - ${LE_HOST_KEY:-NGINX_SSL_HOST}=prowlarr.${HTTP_HOST:-}
      - LETSENCRYPT_EMAIL=${LETSENCRYPT_EMAIL:-}
    volumes:
      - ./config/prowlarr:/config
    depends_on:
      - pia
    restart: unless-stopped

  #=============================================================================
  # download clients
  #=============================================================================

  nzbget:
    image: linuxserver/nzbget
    container_name: nzbget
    logging: *default-logging
    environment:
      # nzbget
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-Europe/London}
      # dockergen
      - "VIRTUAL_HOST=\
          nzbget.${HTTP_HOST:-127.0.0.1.sslip.io},\
          ~^nzbget\\.[0-9a-f:.]+\\.sslip\\.io$$"
      - CERT_NAME=nzbget.${HTTP_HOST:-127.0.0.1.sslip.io}
      - VIRTUAL_PORT=6789
      # nginx-proxy-letsencrypt
      - ${LE_HOST_KEY:-NGINX_SSL_HOST}=nzbget.${HTTP_HOST:-}
      - LETSENCRYPT_EMAIL=${LETSENCRYPT_EMAIL:-}
    volumes:
      - ./config/nzbget:/config
      - ./share/nzbget:/usr/share/nzbget
      - ./media:/media
      # Optional volumes, e.g. to follow symlinks
      - ${EXTRA_DATA_VOL_0:-/dev/null}:${EXTRA_DATA_VOL_0:-/dev/null0}
      - ${EXTRA_DATA_VOL_1:-/dev/null}:${EXTRA_DATA_VOL_1:-/dev/null1}
      - ${EXTRA_DATA_VOL_2:-/dev/null}:${EXTRA_DATA_VOL_2:-/dev/null2}
      - ${EXTRA_DATA_VOL_3:-/dev/null}:${EXTRA_DATA_VOL_3:-/dev/null3}
      - ${EXTRA_DATA_VOL_4:-/dev/null}:${EXTRA_DATA_VOL_4:-/dev/null4}
      - ${EXTRA_DATA_VOL_5:-/dev/null}:${EXTRA_DATA_VOL_5:-/dev/null5}
      # # NTFS-3G directory junction mappings
      # - ./share/.NTFS-3G:/mnt/${NTFS_DRIVE:-c}/.NTFS-3G:ro
    restart: unless-stopped

  deluge:
    image: linuxserver/deluge
    container_name: deluge
    logging: *default-logging
    network_mode: service:pia
    entrypoint: /usr/local/bin/init
    environment:
      # deluge
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-Europe/London}
      - UMASK_SET=002
      # dockergen
      - NETWORK_ACCESS=internal
    volumes:
      - ./config/deluge:/config
      - ./config/pia:/gluetun:ro
      - ./media:/media
      - ./share/deluge/init:/usr/local/bin/init
      # Optional volumes, e.g. to follow symlinks
      - ${EXTRA_DATA_VOL_0:-/dev/null}:${EXTRA_DATA_VOL_0:-/dev/null0}
      - ${EXTRA_DATA_VOL_1:-/dev/null}:${EXTRA_DATA_VOL_1:-/dev/null1}
      - ${EXTRA_DATA_VOL_2:-/dev/null}:${EXTRA_DATA_VOL_2:-/dev/null2}
      - ${EXTRA_DATA_VOL_3:-/dev/null}:${EXTRA_DATA_VOL_3:-/dev/null3}
      - ${EXTRA_DATA_VOL_4:-/dev/null}:${EXTRA_DATA_VOL_4:-/dev/null4}
      - ${EXTRA_DATA_VOL_5:-/dev/null}:${EXTRA_DATA_VOL_5:-/dev/null5}
      # # NTFS-3G directory junction mappings
      # - ./share/.NTFS-3G:/mnt/${NTFS_DRIVE:-c}/.NTFS-3G:ro
    depends_on:
      - pia
    restart: unless-stopped

  #=============================================================================
  # http reverse proxy
  #=============================================================================

  nginx:
    image: jwilder/nginx-proxy
    container_name: nginx
    logging: *default-logging
    ports:
      - ${HTTP_PORT:-8080}:80
      - ${HTTPS_PORT:-8443}:443
    volumes:
      - /var/run/docker.sock:/tmp/docker.sock:ro
      - ./config/nginx/nginx.tmpl:/app/nginx.tmpl
      - ./config/nginx/certs:/etc/nginx/certs
      - ./config/nginx/certs:/etc/nginx/dhparam
      - ./config/nginx/conf.d:/etc/nginx/conf.d
      - ./config/nginx/vhost.d:/etc/nginx/vhost.d
      - ./share/nginx/html:/usr/share/nginx/html
    restart: unless-stopped

  letsencrypt:
    image: jrcs/letsencrypt-nginx-proxy-companion
    container_name: letsencrypt
    logging: *default-logging
    volumes_from:
      - nginx
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    depends_on:
      - nginx
    restart: unless-stopped

  #=============================================================================
  # privacy
  #=============================================================================

  pia:
    image: qmcgaw/gluetun
    container_name: pia
    logging: *default-logging
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun
    ports:
      # deluge
      - 8112:8112
      # http-proxy
      - 8888:8888
    environment:
      # pia
      - USER=$PIA_USERNAME
      - PASSWORD=$PIA_PASSWORD
      - REGION=${PIA_REGION:-UK London}
      - PROTOCOL=${PIA_PROTOCOL:-udp}
      # - FIREWALL_OUTBOUND_SUBNETS=172.16.0.0/12,10.0.0.0/8
      - PIA_ENCRYPTION=${PIA_ENCRYPTION:-normal}
      - PORT_FORWARDING=on
      - PORT_FORWARDING_STATUS_FILE=/gluetun/forwarded_port
      - HTTPPROXY=on
      # dockergen
      - "VIRTUAL_HOST=\
          deluge.${HTTP_HOST:-127.0.0.1.sslip.io},\
          ~^deluge\\.[0-9a-f:.]+\\.sslip\\.io$$"
      - CERT_NAME=deluge.${HTTP_HOST:-127.0.0.1.sslip.io}
      - VIRTUAL_PORT=8112
      # nginx-proxy-letsencrypt
      - ${LE_HOST_KEY:-NGINX_SSL_HOST}=deluge.${HTTP_HOST:-}
      - LETSENCRYPT_EMAIL=${LETSENCRYPT_EMAIL:-}
    volumes:
      - ./config/pia:/gluetun
    restart: unless-stopped

  #=============================================================================
  # container management
  #=============================================================================

  portainer:
    image: portainer/portainer-ce
    container_name: portainer
    logging: *default-logging
    environment:
      # portainer
      - DATABASE_FILES=portainer
      - DATABASE_PATH=/data
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-Europe/London}
      - VERSION=docker
      # dockergen
      - "VIRTUAL_HOST=\
          portainer.${HTTP_HOST:-127.0.0.1.sslip.io},\
          ~^portainer\\.[0-9a-f:.]+\\.sslip\\.io$$"
      - CERT_NAME=portainer.${HTTP_HOST:-127.0.0.1.sslip.io}
      - VIRTUAL_PORT=9000
      # nginx-proxy-letsencrypt
      - ${LE_HOST_KEY:-NGINX_SSL_HOST}=portainer.${HTTP_HOST:-}
      - LETSENCRYPT_EMAIL=${LETSENCRYPT_EMAIL:-}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./config/portainer:/data
    restart: unless-stopped

  #=============================================================================
  # host management
  #=============================================================================

  ddclient:
    image: linuxserver/ddclient
    container_name: ddclient
    logging: *default-logging
    environment:
      # ddclient
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-Europe/London}
      # dockergen
      - NETWORK_ACCESS=internal
    volumes:
      - ./config/ddclient:/config
    restart: unless-stopped

volumes:
  plex_database:
  sonarr_database:
  radarr_database:
  lidarr_database:
